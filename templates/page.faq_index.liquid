{%- comment -%}
  page.faq_index.liquid (Baklib Template)
  - 集成了最新的 HTML/Tailwind 结构与响应式筛选器逻辑
  - 保持原有的 Liquid 数据获取方式：site.pages / faq_root.children
  - JS 负责 UI 交互：下拉菜单、移动端底部弹窗、折叠面板、URL 参数同步
{%- endcomment -%}

{%- assign faq_root = page -%}
{%- assign all_pages = faq_root.pages -%}

<style>
  /* 补充 CSS 动画 */
  .accordion-content { transition: max-height 0.3s ease-out; }
  .mobile-sheet { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  .mobile-overlay { transition: opacity 0.3s ease; }
  body.modal-open { overflow: hidden; }
</style>

<div class="bg-gray-50 min-h-screen font-sans text-gray-900">
  <div class="max-w-4xl mx-auto px-4 py-8">

    <!-- 面包屑导航 -->
    <nav class="flex items-center text-sm text-gray-500 mb-8">
      <a href="/" class="hover:text-gray-800">{{ site.name }}</a>
      <span class="mx-2">></span>
      <span class="text-gray-800">{{ page.link_text }}</span>
    </nav>

    <!-- 主内容卡片 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:p-12">
      <h1 class="text-3xl font-bold mb-8">{{ page.link_text }}</h1>

      <!-- 产品筛选器 -->
      <div class="mb-12">
        <p class="text-sm font-medium text-gray-500 mb-3">Choose Product Model</p>

        <div class="relative w-full max-w-md" id="filterContainer">
          <div id="filterHeader" class="flex items-center justify-between p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-gray-300 transition-colors bg-white">
            <div class="flex items-center gap-3">
              <!-- 缩略图容器 (JS 将在有图片时替换 svg) -->
              <div id="thumbBox" class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center overflow-hidden">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
              </div>

              <!-- 选中的产品名称 (由 JS 设置) -->
              <span id="selectedName" class="font-medium text-gray-800">Choose Product Model</span>
            </div>

            <svg class="w-5 h-5 text-gray-400 transform transition-transform" id="arrowIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>

          <!-- PC 端下拉菜单 -->
          <div id="pcDropdown" class="hidden absolute top-full left-0 mt-2 w-[500px] bg-white border border-gray-200 rounded-xl shadow-xl z-50 flex overflow-hidden">
            <div id="pcCategoryList" class="w-[200px] border-r border-gray-100 py-2 bg-gray-50/50">
              {%- for cat in faq_root.children -%}
                <div
                  class="px-5 py-3 text-[14px] cursor-pointer flex justify-between items-center transition-colors text-gray-500 hover:bg-white/80"
                  data-cat="{{ cat.slug }}"
                >
                  {{ cat.link_text }}
                  <span class="text-[12px] text-gray-300">›</span>
                </div>
              {%- endfor -%}
            </div>

            <div id="pcProductList" class="flex-1 py-2 max-h-80 overflow-y-auto">
              {%- for cat in faq_root.children -%}
                {%- for prod in cat.children -%}
                  <div
                    class="px-8 py-3 text-[14px] cursor-pointer hover:bg-gray-50 transition-colors text-gray-600 hidden"
                    data-cat="{{ cat.slug }}"
                    data-product="{{ prod.slug }}"
                    data-name="{{ prod.link_text | escape }}"
                    data-thumb="{{ prod.settings.thumbnail | default: '' | escape }}"
                  >
                    {{ prod.link_text }}
                  </div>
                {%- endfor -%}
              {%- endfor -%}
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Answer (FAQ 列表) -->
      <div class="mb-12">
        <h2 class="text-xl font-bold mb-6">Quick Answer</h2>

        <div class="space-y-3" id="quickAnswerContainer">
          {%- for p in all_pages -%}
            {%- if p.template_name == 'faq_qna' -%}
              {%- assign prod = p.parent -%}
              {%- assign cat = prod.parent -%}

              <div
                class="border border-gray-100 bg-gray-50/30 rounded-lg overflow-hidden"
                data-type="qna"
                data-cat="{{ cat.slug }}"
                data-product="{{ prod.slug }}"
                data-q="{{ p.slug }}"
              >
                <button class="w-full px-5 py-4 flex justify-between items-center text-left hover:bg-gray-50 transition-colors" onclick="toggleFAQ(this)">
                  <span class="text-[15px] text-gray-700 font-medium">{{ p.link_text }}</span>
                  <svg class="w-4 h-4 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>

                <div class="accordion-content max-h-0 overflow-hidden bg-white" data-open="0">
                  <div class="px-5 py-4 text-sm text-gray-600 leading-relaxed">
                    {{ p.body }}
                  </div>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>

      <!-- Visual Guides (指南列表) -->
      <div>
        <h2 class="text-xl font-bold mb-6">Visual Guides</h2>

        <div class="space-y-3" id="visualGuidesContainer">
          {%- for p in all_pages -%}
            {%- if p.template_name == 'faq_detail' -%}
              {%- assign prod = p.parent -%}
              {%- assign cat = prod.parent -%}

              <a
                href="{{ p.url }}"
                class="flex items-center justify-between p-4 border border-gray-100 bg-gray-50/30 rounded-lg hover:bg-gray-50 transition-colors group"
                data-type="guide"
                data-cat="{{ cat.slug }}"
                data-product="{{ prod.slug }}"
              >
                <span class="text-[15px] text-gray-700">{{ p.link_text }}</span>
                <svg class="w-4 h-4 text-gray-300 group-hover:text-gray-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </a>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>

    </div>
  </div>

  <!-- 移动端底部弹窗 (修正版) -->
  <div id="mobileOverlay" class="hidden fixed inset-0 bg-black/50 z-[100] mobile-overlay opacity-0"></div>

  <div id="mobileSheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl z-[101] mobile-sheet transform translate-y-full max-h-[80vh] flex flex-col">
    <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
      <span class="font-bold text-[17px]">Choose Product Model</span>
      <button id="closeSheet" class="p-1 text-gray-400">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div id="mobileAccordion" class="overflow-y-auto flex-1 pb-12">
      {%- for cat in faq_root.children -%}
        <div class="border-b border-gray-50" data-cat="{{ cat.slug }}">
          <div class="px-5 py-5 flex justify-between items-center cursor-pointer group mobile-cat-header" onclick="toggleMobileCategory(this)">
            <span class="text-[15px] text-gray-800">{{ cat.link_text }}</span>
            <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>

          <div class="accordion-content overflow-hidden mobile-cat-content" style="max-height: 0px">
            <div class="pb-2">
              {%- for prod in cat.children -%}
                <div
                  class="px-10 py-3.5 text-[14px] text-gray-500 mobile-product-item cursor-pointer"
                  data-cat="{{ cat.slug }}"
                  data-product="{{ prod.slug }}"
                  data-name="{{ prod.link_text | escape }}"
                  data-thumb="{{ prod.settings.thumbnail | default: '' | escape }}"
                  onclick="selectProductFromEl(this)"
                >
                  {{ prod.link_text }}
                </div>
              {%- endfor -%}
            </div>
          </div>
        </div>
      {%- endfor -%}
    </div>
  </div>
</div>

<script>
  // --- DOM 元素获取 ---
  const filterHeader = document.getElementById('filterHeader');
  const pcDropdown = document.getElementById('pcDropdown');
  const pcCategoryList = document.getElementById('pcCategoryList');
  const pcProductList = document.getElementById('pcProductList');
  const selectedNameDisplay = document.getElementById('selectedName');
  const arrowIcon = document.getElementById('arrowIcon');
  const thumbBox = document.getElementById('thumbBox');
  const mobileOverlay = document.getElementById('mobileOverlay');
  const mobileSheet = document.getElementById('mobileSheet');
  const closeSheet = document.getElementById('closeSheet');

  // --- 状态管理 (从 URL 同步) ---
  const params = new URLSearchParams(location.search);
  let currentCategoryId = params.get('cat') || '';
  let selectedProductId = params.get('product') || '';
  let openQId = params.get('q') || '';

  // PC 端分类悬停状态 (不改变全局选择)
  let hoverCategoryId = currentCategoryId || '';

  function isMobile() { return window.innerWidth < 768; }

  // 更新 URL 参数 (无刷新)
  function updateUrl(cat, product) {
    const url = new URL(location.href);
    if (cat) url.searchParams.set('cat', cat); else url.searchParams.delete('cat');
    if (product) url.searchParams.set('product', product); else url.searchParams.delete('product');
    history.replaceState(null, '', url.toString());
  }

  // 设置筛选器头部显示
  function setHeaderDisplay(name, thumbUrl) {
    selectedNameDisplay.textContent = name || 'Choose Product Model';
    if (thumbUrl) {
      thumbBox.innerHTML = '<img src="' + thumbUrl + '" alt="" class="w-full h-full object-cover">';
    } else {
      thumbBox.innerHTML = '<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>';
    }
  }

  // 根据分类显示产品列表 (PC)
  function showProductsForCategory(catId) {
    document.querySelectorAll('#pcProductList [data-product]').forEach(el => {
      el.classList.toggle('hidden', el.dataset.cat !== catId);
    });

    // 高亮当前选中的分类 (非悬停分类)
    document.querySelectorAll('#pcCategoryList [data-cat]').forEach(el => {
      const active = el.dataset.cat === currentCategoryId;
      el.classList.toggle('bg-white', active);
      el.classList.toggle('text-gray-900', active);
      el.classList.toggle('font-bold', active);
      el.classList.toggle('text-gray-500', !active);
    });
  }

  // 高亮选中的产品 (PC & Mobile)
  function highlightSelectedProduct() {
    document.querySelectorAll('#pcProductList [data-product]').forEach(el => {
      const active = (el.dataset.cat === currentCategoryId && el.dataset.product === selectedProductId);
      el.classList.toggle('text-gray-900', active);
      el.classList.toggle('font-bold', active);
      el.classList.toggle('text-gray-600', !active);
    });

    document.querySelectorAll('#mobileAccordion .mobile-product-item').forEach(el => {
      const active = (el.dataset.cat === currentCategoryId && el.dataset.product === selectedProductId);
      el.classList.toggle('text-blue-500', active);
      el.classList.toggle('font-medium', active);
      el.classList.toggle('text-gray-500', !active);
    });
  }

  // 过滤内容区域 (FAQ & Guides)
  function applyContentFilter() {
    document.querySelectorAll('[data-type="qna"], [data-type="guide"]').forEach(el => {
      const okCat = !currentCategoryId || el.dataset.cat === currentCategoryId;
      const okProd = !selectedProductId || el.dataset.product === selectedProductId;
      el.style.display = (okCat && okProd) ? '' : 'none';
    });
  }

  // --- PC 端交互逻辑 ---
  filterHeader.onclick = (e) => {
    if (isMobile()) {
      openMobileSheet();
    } else {
      pcDropdown.classList.toggle('hidden');
      arrowIcon.style.transform = pcDropdown.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
      if (!pcDropdown.classList.contains('hidden')) {
        hoverCategoryId = currentCategoryId || hoverCategoryId;
        if (hoverCategoryId) showProductsForCategory(hoverCategoryId);
      }
    }
    e.stopPropagation();
  };

  document.addEventListener('click', (e) => {
    if (!document.getElementById('filterContainer').contains(e.target)) {
      pcDropdown.classList.add('hidden');
      arrowIcon.style.transform = 'rotate(0deg)';
    }
  });

  // PC 端分类悬停
  document.querySelectorAll('#pcCategoryList [data-cat]').forEach(el => {
    el.addEventListener('mouseenter', () => {
      hoverCategoryId = el.dataset.cat;
      showProductsForCategory(hoverCategoryId);
      highlightSelectedProduct();
    });
  });

  // PC 端产品选择
  document.querySelectorAll('#pcProductList [data-product]').forEach(el => {
    el.addEventListener('click', () => {
      currentCategoryId = el.dataset.cat;
      selectedProductId = el.dataset.product;
      hoverCategoryId = currentCategoryId;

      setHeaderDisplay(el.dataset.name, el.dataset.thumb);
      updateUrl(currentCategoryId, selectedProductId);
      applyContentFilter();
      highlightSelectedProduct();
      showProductsForCategory(currentCategoryId);

      pcDropdown.classList.add('hidden');
      arrowIcon.style.transform = 'rotate(0deg)';
    });
  });

  // --- 移动端弹窗交互逻辑 ---
  function openMobileSheet() {
    mobileOverlay.classList.remove('hidden');
    setTimeout(() => {
      mobileOverlay.classList.add('opacity-100');
      mobileSheet.style.transform = 'translateY(0)';
      document.body.classList.add('modal-open');
    }, 10);
    openMobileCategory(currentCategoryId);
    highlightSelectedProduct();
  }

  function closeMobileSheet() {
    mobileOverlay.classList.remove('opacity-100');
    mobileSheet.style.transform = 'translateY(100%)';
    document.body.classList.remove('modal-open');
    setTimeout(() => { mobileOverlay.classList.add('hidden'); }, 300);
  }

  closeSheet.onclick = closeMobileSheet;
  mobileOverlay.onclick = closeMobileSheet;

  // 移动端展开指定分类
  function openMobileCategory(catId) {
    if (!catId) return;
    const wrapper = document.querySelector('#mobileAccordion [data-cat="' + CSS.escape(catId) + '"]');
    if (!wrapper) return;
    document.querySelectorAll('#mobileAccordion .mobile-cat-content').forEach(c => {
      c.style.maxHeight = '0px';
      const icon = c.previousElementSibling && c.previousElementSibling.querySelector('svg');
      if (icon) icon.classList.remove('rotate-180');
    });
    const header = wrapper.querySelector('.mobile-cat-header');
    const content = wrapper.querySelector('.mobile-cat-content');
    const icon = header && header.querySelector('svg');
    if (content) content.style.maxHeight = '1000px';
    if (icon) icon.classList.add('rotate-180');
  }

  window.toggleMobileCategory = (header) => {
    const content = header.nextElementSibling;
    const icon = header.querySelector('svg');
    const isOpen = content.style.maxHeight !== '0px';
    document.querySelectorAll('#mobileAccordion .mobile-cat-content').forEach(c => {
      if (c !== content) {
        c.style.maxHeight = '0px';
        const i = c.previousElementSibling && c.previousElementSibling.querySelector('svg');
        if (i) i.classList.remove('rotate-180');
      }
    });
    if (isOpen) {
      content.style.maxHeight = '0px';
      icon.classList.remove('rotate-180');
    } else {
      content.style.maxHeight = '1000px';
      icon.classList.add('rotate-180');
    }
  };

  window.selectProductFromEl = (el) => {
    currentCategoryId = el.dataset.cat;
    selectedProductId = el.dataset.product;
    hoverCategoryId = currentCategoryId;
    setHeaderDisplay(el.dataset.name, el.dataset.thumb);
    updateUrl(currentCategoryId, selectedProductId);
    applyContentFilter();
    highlightSelectedProduct();
    showProductsForCategory(currentCategoryId);
    closeMobileSheet();
  };

  // --- Quick Answer 折叠面板 ---
  window.toggleFAQ = (btn) => {
    const content = btn.nextElementSibling;
    const icon = btn.querySelector('svg');
    const isOpen = content.dataset.open === '1';
    if (isOpen) {
      content.style.maxHeight = '0px';
      content.dataset.open = '0';
      icon.style.transform = 'rotate(0deg)';
    } else {
      document.querySelectorAll('#quickAnswerContainer .accordion-content[data-open="1"]').forEach(el => {
        if (el !== content) {
          el.style.maxHeight = '0px';
          el.dataset.open = '0';
          const b = el.parentElement && el.parentElement.querySelector('button svg');
          if (b) b.style.transform = 'rotate(0deg)';
        }
      });
      content.style.maxHeight = content.scrollHeight + 'px';
      content.dataset.open = '1';
      icon.style.transform = 'rotate(180deg)';
    }
  };

  // --- 初始化状态 ---
  function initDefaultSelection() {
    let match = null;
    if (currentCategoryId && selectedProductId) {
      match = document.querySelector('#pcProductList [data-cat="' + CSS.escape(currentCategoryId) + '"][data-product="' + CSS.escape(selectedProductId) + '"]');
    }
    if (!match) {
      match = document.querySelector('#pcProductList [data-product]');
      if (match) {
        currentCategoryId = match.dataset.cat;
        selectedProductId = match.dataset.product;
        hoverCategoryId = currentCategoryId;
      }
    }
    if (match) {
      setHeaderDisplay(match.dataset.name, match.dataset.thumb);
    }
    showProductsForCategory(currentCategoryId || hoverCategoryId);
    highlightSelectedProduct();
    applyContentFilter();
  }

  initDefaultSelection();
</script>

{% schema %}
{
  "name": "FAQ Index",
  "description": "FAQ aggregation page with category/product filter, Quick Answer accordion, and Visual Guides",
  "thumb_url": "images/schema/page.png",
  "sub_page_templates": ["faq_category"]
}
{% endschema %}
